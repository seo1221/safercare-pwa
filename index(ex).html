<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#427825">
  <title>SaferCare 알림 설정</title>

  <!-- PWA meta -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root { --brand:#427825c2; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
           max-width: 780px; margin: 40px auto; padding: 0 16px; line-height: 1.6; }
    h1 { font-size: 2rem; margin-bottom: .5rem; }
    h2 { font-size: 1.25rem; margin-top: 2rem; }
    code, pre { background: #f6f8fa; padding: 6px 8px; border-radius: 6px; }
    .muted { color:#667085; }
    .ok { color:#0a7; }
    .err { color:#d12; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    button { padding: 10px 16px; border-radius: 10px; border: 1px solid #cbd5e1; cursor: pointer; }
    button.primary { background: var(--brand); color:#fff; border-color: var(--brand); }
    details { border:1px solid #e5e7eb; border-radius:12px; padding:12px 16px; background:#fff; }
    details > summary { cursor:pointer; font-weight:600; }
    #out{
      white-space: pre-wrap;     /* 줄바꿈 허용 */
      overflow-wrap: anywhere;   /* 단어 중간이라도 줄바꿈 */
      word-break: break-all;     /* 구형 브라우저 대비 */
      max-width: 100%;
  </style>
</head>
<body>
  <h1>SaferCare 알림 설정</h1>
  <p class="muted">이 페이지에서 알림 권한을 허용하고, 기기를 SaferCare 푸시 알림에 등록할 수 있습니다.</p>

  <!-- 아이폰 설정 방법 -->
  <h2>아이폰 설정 방법</h2>
  <details open>
    <summary>단계 보기</summary>
    <ol>
      <li>Safari로 이 페이지를 엽니다.</li>
      <li><b>공유</b> 버튼을 눌러 <b>홈 화면에 추가</b>로 설치합니다. (필수)</li>
      <li>홈 화면의 SaferCare 아이콘으로 실행합니다.</li>
      <li>아래 <b>알림 설정</b> 버튼을 눌러 권한을 <b>허용</b>합니다.</li>
    </ol>
    <p class="muted">설치 없이 브라우저 탭에서 보면 iOS에서 알림이 동작하지 않을 수 있어요.</p>
  </details>

  <!-- 안내/설명(기존 문구 유지) -->
  <h2>설명</h2>
  <ol>
    <li>이 페이지는 웹 알림 토큰을 발급하고 서버에 등록합니다.</li>
    <li>서버 주소는 <code>serverInfo.registerEndpoint</code> 한 줄만 바꾸면 됩니다.</li>
  </ol>

  <div style="margin:20px 0;">
    <button id="enable" class="primary">알림 설정</button>
  </div>

  <p id="status" class="muted"></p>
  <pre id="out" class="card" style="min-height:48px;"></pre>

  <!-- 기능 로직: 기존과 동일 (UI 텍스트만 바뀜) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

    //프로젝트 값 그대로 (필요시 교체)
    const firebaseConfig = {
      apiKey: "AIzaSyCRkR_G3dOPNMmLG7KWgl2zJNshy5p3YZs",
      authDomain: "alarmtest-13e42.firebaseapp.com",
      projectId: "alarmtest-13e42",
      storageBucket: "alarmtest-13e42.firebasestorage.app",
      messagingSenderId: "685591126765",
      appId: "1:685591126765:web:ae166348fbc661439062e4",
    };

    //서버 한 줄만 교체
    const serverInfo = {
      registerEndpoint: "https://exiguous-leroy-smilingly.ngrok-free.dev/register_token",
      bearerToken: "qwertyuiop"
    };

    const app = initializeApp(firebaseConfig);
    const statusEl = document.getElementById('status');
    const outEl = document.getElementById('out');

    // 서비스워커는 현재 폴더 기준(서브폴더 배포 안전)
    const swReg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');

    const supported = await isSupported();
    statusEl.innerHTML = supported
      ? '<span class="ok">이 브라우저는 웹 알림을 지원합니다.</span>'
      : '<span class="err">이 브라우저에서는 웹 알림이 지원되지 않습니다.</span>';

    async function enable() {
      try {
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') {
          outEl.textContent = '알림 권한이 거부되었습니다.';
          return;
        }
        const messaging = getMessaging(app);
        // VAPID 공개키로 유지
        const vapidKey = "BAiBoxkRryzfRnCg8LSrSWYxs84DzE2P4V4nx1u3zPE42jRKMtuAXwmSqDtGyX1-ww2z0R3F-vpG7la9VKz_1q4";
        const token = await getToken(messaging, { vapidKey, serviceWorkerRegistration: swReg });

        outEl.textContent = "토큰 발급 완료:\n" + token + "\n\n서버에 등록 중...";
        const url = new URL(serverInfo.registerEndpoint);
        url.searchParams.set("token", token);
        const resp = await fetch(url.toString(), {
          method: "POST",
          headers: { "Authorization": "Bearer " + serverInfo.bearerToken }
        });
        const data = await resp.json();
        outEl.textContent += "\n등록 결과: " + JSON.stringify(data, null, 2);
      } catch (err) {
        console.error(err);
        outEl.textContent = "에러: " + err;
      }
    }

    document.getElementById('enable').addEventListener('click', enable);

    // 포그라운드 메시지 로그 (원하면 리다이렉트 처리 등 여기서)
    const messaging = getMessaging(app);
    onMessage(messaging, (payload) => {
      console.log('Foreground message:', payload);
      // if (payload?.data?.url) location.href = payload.data.url; // 필요 시 활성화
    });
  </script>
</body>
</html>
