<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SaferCare</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="./icon-180.png" />
  <meta name="theme-color" content="#427825" />

  <style>
    body {
      background:#fff; max-width: 780px; margin: 28px auto; padding: 0 16px;
      font: 16px/1.6 ui-sans-serif, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#111;
    }
    header { padding: 8px 0 12px; }
    header h1 { margin: 0; font-size: 28px; letter-spacing:-.3px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:16px; }
    .muted { color:#667085; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn { appearance: none; border:1px solid #cbd5e1; background:#f8fafc; padding:10px 16px; border-radius:10px; cursor:pointer; }
    .btn.primary { background:#427825; color:#fff; border-color:#427825; }
    details { border:1px solid #e5e7eb; border-radius:14px; padding:12px 16px; background:#fff; }
    details > summary { cursor:pointer; font-weight:600; margin:-4px 0 8px; }
    #out { white-space: pre-wrap; overflow-wrap:anywhere; word-break:break-all; max-width:100%; }
  </style>
</head>
<body>
  <header>
    <h1>SaferCare</h1>
    <p class="muted">현장의 이상 상황을 즉시 알려드려요.</p>
  </header>

  <section id="stateCard" class="card">
    <div id="state-off">
      <h2 style="margin:0 0 8px 0; font-size:20px;">실시간 알림</h2>
      <p class="muted" style="margin-top:0;">아래 버튼을 눌러 이 기기에 알림을 켜세요.</p>
      <div class="row">
        <button id="enable" class="btn primary">알림 켜기</button>
        <small id="status" class="muted"></small>
      </div>

      <h3 style="margin:18px 0 8px; font-size:18px;">아이폰 설정 방법</h3>
      <details>
        <summary>단계 보기</summary>
        <ol style="margin:8px 0;">
          <li>Safari로 이 페이지를 엽니다.</li>
          <li><b>공유</b> → <b>홈 화면에 추가</b>로 설치합니다. (필수)</li>
          <li>홈 화면의 SaferCare 아이콘으로 실행합니다.</li>
          <li><b>알림 켜기</b> 버튼을 눌러 권한을 <b>허용</b>합니다.</li>
        </ol>
      </details>
    </div>

    <div id="state-on" style="display:none;">
      <h2 style="margin:0 0 6px 0; font-size:20px;">알림 수신 중</h2>
      <p class="muted" style="margin-top:0;">이 기기는 SaferCare 알림을 받을 준비가 됐습니다.</p>
      <div class="row">
        <a id="openDashboard" class="btn" href="#" target="_blank" rel="noopener">대시보드 열기</a>
        <button id="reEnable" class="btn">알림 재등록</button>
        <small class="muted">알림이 오지 않을 때 재설정하세요.</small>
      </div>
    </div>
  </section>

  <section style="margin-top:16px;">
    <details>
      <summary>진단 정보</summary>
      <pre id="out" class="card" style="min-height:48px;"></pre>
    </details>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getMessaging, getToken, isSupported, onMessage, deleteToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

    // 서버 수정 시
    const serverInfo = {
      registerEndpoint: "https://exiguous-leroy-smilingly.ngrok-free.dev/register_token",
      bearerToken: "qwerty",
    };

    // 대시보드 링크
    const lookerURL = "https://lookerstudio.google.com/reporting/f01694a6-2ccf-4521-bb47-d849ce0144d1";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCRkR_G3dOPNMmLG7KWgl2zJNshy5p3YZs",
      authDomain: "alarmtest-13e42.firebaseapp.com",
      projectId: "alarmtest-13e42",
      storageBucket: "alarmtest-13e42.firebasestorage.app",
      messagingSenderId: "685591126765",
      appId: "1:685591126765:web:ae166348fbc661439062e4",
    };

    const app = initializeApp(firebaseConfig);
    const supported = await isSupported();
    const stateOff = document.getElementById('state-off');
    const stateOn  = document.getElementById('state-on');
    const statusEl = document.getElementById('status');
    const outEl    = document.getElementById('out');
    const openDashboard = document.getElementById('openDashboard');

    // 서비스워커 등록
    const swReg = await navigator.serviceWorker.register('./firebase-messaging-sw.js?v=3');

    // 기기ID: 최초 1회 생성 후 localStorage에 고정 보관
    let deviceId = localStorage.getItem('sc_device_id');
    if (!deviceId) {
      deviceId = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)) + '-web';
      localStorage.setItem('sc_device_id', deviceId);
    }

    function setUI(on) {
      stateOff.style.display = on ? 'none' : '';
      stateOn.style.display  = on ? '' : 'none';
      if (on) openDashboard.href = lookerURL;
    }

    // 초기 상태
    if (!supported) {
      statusEl.textContent = '이 브라우저는 웹 알림을 지원하지 않습니다.';
    } else {
      const saved = localStorage.getItem('sc_push_token');
      const perm = Notification.permission;
      setUI(!!saved && perm === 'granted');
    }

    async function registerToServer(token, prevToken) {
      const url = new URL(serverInfo.registerEndpoint);
      url.searchParams.set("token", token);
      url.searchParams.set("device", deviceId);                            // 같은 기기 중복 방지 핵심
      if (prevToken && prevToken !== token) url.searchParams.set("prev", prevToken);
      const resp = await fetch(url.toString(), {
        method: "POST",
        headers: { "Authorization": "Bearer " + serverInfo.bearerToken }
      });
      return resp.json();
    }

    async function enable() {
      try {
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') { statusEl.textContent = '알림 권한이 거부되었습니다.'; return; }

        const messaging = getMessaging(app);
        const vapidKey = "BAiBoxkRryzfRnCg8LSrSWYxs84DzE2P4V4nx1u3zPE42jRKMtuAXwmSqDtGyX1-ww2z0R3F-vpG7la9VKz_1q4";
        const token = await getToken(messaging, { vapidKey, serviceWorkerRegistration: swReg });

        const prev = localStorage.getItem('sc_push_token') || "";

        // 동일 토큰이면 서버 호출 생략(멱등)
        if (prev && prev === token) {
          setUI(true);
          statusEl.textContent = '이미 등록된 기기입니다.';
          return;
        }

        outEl.textContent = "토큰 발급 완료:\n" + token + "\n\n서버에 등록 중...";
        const data = await registerToServer(token, prev);
        outEl.textContent += "\n등록 결과: " + JSON.stringify(data, null, 2);

        localStorage.setItem('sc_push_token', token);
        setUI(true);
      } catch (err) {
        console.error(err);
        outEl.textContent = "에러: " + err;
      }
    }

    document.getElementById('enable').addEventListener('click', enable);

    // 재등록 — 토큰만 초기화, deviceId는 유지(같은 기기 중복 방지)
    document.getElementById('reEnable').addEventListener('click', async () => {
      try { const messaging = getMessaging(app); await deleteToken(messaging); } catch(e){}
      localStorage.removeItem('sc_push_token');
      setUI(false);
      statusEl.textContent = '다시 등록해 주세요.';
    });

    onMessage(getMessaging(app), (payload) => {
      console.log('Foreground message:', payload);
    });
  </script>
</body>
</html>
