<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SaferCare ì•Œë¦¼ ì„¤ì •</title>

  <!-- PWA meta -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root { --brand:#9ce48eb3; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
           max-width: 780px; margin: 40px auto; padding: 0 16px; line-height: 1.6; }
    h1 { font-size: 2rem; margin-bottom: .5rem; }
    h2 { font-size: 1.25rem; margin-top: 2rem; }
    code, pre { background: #f6f8fa; padding: 6px 8px; border-radius: 6px; }
    .muted { color:#667085; }
    .ok { color:#0a7; }
    .err { color:#d12; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }
    button { padding: 10px 16px; border-radius: 10px; border: 1px solid #cbd5e1; cursor: pointer; }
    button.primary { background: var(--brand); color:#fff; border-color: var(--brand); }
    details { border:1px solid #e5e7eb; border-radius:12px; padding:12px 16px; background:#fff; }
    details > summary { cursor:pointer; font-weight:600; }
  </style>
</head>
<body>
  <h1>SaferCare ì•Œë¦¼ ì„¤ì •</h1>
  <p class="muted">ì´ í˜ì´ì§€ì—ì„œ ì•Œë¦¼ ê¶Œí•œì„ í—ˆìš©í•˜ê³ , ê¸°ê¸°ë¥¼ SaferCare í‘¸ì‹œ ì•Œë¦¼ì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

  <!-- ì•„ì´í° ì„¤ì • ë°©ë²• -->
  <h2>ì•„ì´í° ì„¤ì • ë°©ë²•</h2>
  <details open>
    <summary>ë‹¨ê³„ ë³´ê¸°</summary>
    <ol>
      <li>Safarië¡œ ì´ í˜ì´ì§€ë¥¼ ì—½ë‹ˆë‹¤.</li>
      <li><b>ê³µìœ </b> ë²„íŠ¼ì„ ëˆŒëŸ¬ <b>í™ˆ í™”ë©´ì— ì¶”ê°€</b>ë¡œ ì„¤ì¹˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)</li>
      <li>í™ˆ í™”ë©´ì˜ SaferCare ì•„ì´ì½˜ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.</li>
      <li>ì•„ë˜ <b>ì•Œë¦¼ ì„¤ì •</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¶Œí•œì„ <b>í—ˆìš©</b>í•©ë‹ˆë‹¤.</li>
    </ol>
    <p class="muted">ì„¤ì¹˜ ì—†ì´ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ ë³´ë©´ iOSì—ì„œ ì•Œë¦¼ì´ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”.</p>
  </details>

  <!-- ì•ˆë‚´/ì„¤ëª…(ê¸°ì¡´ ë¬¸êµ¬ ìœ ì§€) -->
  <h2>ì„¤ëª…</h2>
  <ol>
    <li>ì´ í˜ì´ì§€ëŠ” ì›¹ ì•Œë¦¼ í† í°ì„ ë°œê¸‰í•˜ê³  ì„œë²„ <code>/register_token</code>ì— ë“±ë¡í•©ë‹ˆë‹¤.</li>
    <li>ì„œë²„ ì£¼ì†ŒëŠ” <code>serverInfo.registerEndpoint</code> í•œ ì¤„ë§Œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤.</li>
  </ol>

  <div style="margin:20px 0;">
    <button id="enable" class="primary">ì•Œë¦¼ ì„¤ì •</button>
  </div>

  <p id="status" class="muted"></p>
  <pre id="out" class="card" style="min-height:48px;"></pre>

  <!-- ê¸°ëŠ¥ ë¡œì§: ê¸°ì¡´ê³¼ ë™ì¼ (UI í…ìŠ¤íŠ¸ë§Œ ë°”ë€œ) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

    // ğŸ”§ ë„¤ í”„ë¡œì íŠ¸ ê°’ ê·¸ëŒ€ë¡œ (í•„ìš”ì‹œ êµì²´)
    const firebaseConfig = {
      apiKey: "AIzaSyCRkR_G3dOPNMmLG7KWgl2zJNshy5p3YZs",
      authDomain: "alarmtest-13e42.firebaseapp.com",
      projectId: "alarmtest-13e42",
      storageBucket: "alarmtest-13e42.firebasestorage.app",
      messagingSenderId: "685591126765",
      appId: "1:685591126765:web:ae166348fbc661439062e4",
    };

    // ğŸ”§ ì„œë²„ í•œ ì¤„ë§Œ êµì²´
    const serverInfo = {
      registerEndpoint: "https://exiguous-leroy-smilingly.ngrok-free.dev/register_token",
      bearerToken: "qwertyuiop"
    };

    const app = initializeApp(firebaseConfig);
    const statusEl = document.getElementById('status');
    const outEl = document.getElementById('out');

    // ì„œë¹„ìŠ¤ì›Œì»¤ëŠ” í˜„ì¬ í´ë” ê¸°ì¤€(ì„œë¸Œí´ë” ë°°í¬ ì•ˆì „)
    const swReg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');

    const supported = await isSupported();
    statusEl.innerHTML = supported
      ? '<span class="ok">ì´ ë¸Œë¼ìš°ì €ëŠ” ì›¹ ì•Œë¦¼ì„ ì§€ì›í•©ë‹ˆë‹¤.</span>'
      : '<span class="err">ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì›¹ ì•Œë¦¼ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span>';

    async function enable() {
      try {
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') {
          outEl.textContent = 'ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
          return;
        }
        const messaging = getMessaging(app);
        // ğŸ”§ ë„¤ VAPID ê³µê°œí‚¤ë¡œ ìœ ì§€
        const vapidKey = "BAiBoxkRryzfRnCg8LSrSWYxs84DzE2P4V4nx1u3zPE42jRKMtuAXwmSqDtGyX1-ww2z0R3F-vpG7la9VKz_1q4";
        const token = await getToken(messaging, { vapidKey, serviceWorkerRegistration: swReg });

        outEl.textContent = "í† í° ë°œê¸‰ ì™„ë£Œ:\n" + token + "\n\nì„œë²„ì— ë“±ë¡ ì¤‘...";
        const url = new URL(serverInfo.registerEndpoint);
        url.searchParams.set("token", token);
        const resp = await fetch(url.toString(), {
          method: "POST",
          headers: { "Authorization": "Bearer " + serverInfo.bearerToken }
        });
        const data = await resp.json();
        outEl.textContent += "\në“±ë¡ ê²°ê³¼: " + JSON.stringify(data, null, 2);
      } catch (err) {
        console.error(err);
        outEl.textContent = "ì—ëŸ¬: " + err;
      }
    }

    document.getElementById('enable').addEventListener('click', enable);

    // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ë¡œê·¸ (ì›í•˜ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬ ë“± ì—¬ê¸°ì„œ)
    const messaging = getMessaging(app);
    onMessage(messaging, (payload) => {
      console.log('Foreground message:', payload);
      // if (payload?.data?.url) location.href = payload.data.url; // í•„ìš” ì‹œ í™œì„±í™”
    });
  </script>
</body>
</html>
